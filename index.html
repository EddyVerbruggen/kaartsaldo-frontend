<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=0"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no">
  <title>Kaartsaldo app</title>
  <link rel="stylesheet" href="css/themes/default/jquery.mobile-1.2.0-alpha.1.min.css" type="text/css"/>
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Gudea:400,700,400italic" type="text/css"/>
  <link rel="stylesheet" href="css/kaartsaldo.css" type="text/css"/>
  <script src="js/lib/jquery.js"></script>
  <script src="js/kaartsaldo.custom.js"></script>
  <script src="js/jqm-init.js"></script>
  <script src="js/lib/jquery.mobile-1.2.0-alpha.1.min.js"></script>
  <script src="phonegap.js"></script>
  <script src="barcodescanner.js"></script>
</head>
<body>

<script type="text/javascript">
function loadCardData(cardtype, cardnumber, successFunction) {
//    var url = "http://localhost:9004/cards";
  var url = "http://www.libwat.ch/cards";
  // for SSL, we can use this url, which is libwat.ch
//    var url = "https://morning-stone-3983.herokuapp.com/cards";

  var data = {
    'cardtype':cardtype,
    'cardnumber':cardnumber
  };

  $.mobile.loading('show');

  setTimeout(function () {
    $.ajax({
      data:data,
      dataType:"json",
      async:true,
      type:'POST',
      url:url,
      success:function (data) {
        successFunction(cardtype, data)
      },
      error:function () {
        $.mobile.loading('hide');
        alert('Er is iets misgegaan. Probeer het nogmaals.');
      }
    });
  }, 250);
}

var cardcompany;
function confirmInputtype(cardcompany, testcardnr) {
  this.cardcompany = cardcompany;
  if (isIOS() || isAndroid()) {
    navigator.notification.confirm(
        'Hoe wil je de kaart toevoegen?', // message
        onConfirmCallback, // callback to invoke with index of button pressed
        'Kaart toevoegen', // title
        'Scannen,Intoetsen,Annuleren'   // button labels
    );
  } else {
    if (confirm('Wil je scannen?')) {
      // debugging in browser
      loadCardData(cardcompany, testcardnr, processCardResponse);
    } else if (confirm('Wil je intikken?')) {
      var cardnr = prompt("Wat is het nummer onder de streepjescode?", testcardnr);
      loadCardData(cardcompany, cardnr, processCardResponse);
    }
  }
}

function onConfirmCallback(i) {
  if (i == 1) {
    scan(cardcompany, processCardResponse);
  } else if (i == 2) {
    var cardnr = prompt("Wat is het nummer onder de streepjescode?");
    loadCardData(cardcompany, cardnr, processCardResponse);
  } else if (i == 3) {
    // noop
  }
}

function scan(cardcompany, successFunction) {
  window.plugins.barcodeScanner.scan(function (result) {
        if (!result.cancelled) {
          // Successfully scanned a bar code
//          if (confirm("Is dit het goede nummer? " + result.text)) {
          var checkedNumber = prompt("Controleer het nummer:", result.text);
          loadCardData(cardcompany, checkedNumber, successFunction);
//          } else {
//            confirmInputtype(cardcompany);
//          }
        }
      }, function (error) {
        alert("Scanning failed: " + error);
      }
  );
}

function doTestScan() {
  window.plugins.barcodeScanner.scan(function (result) {
        if (!result.cancelled) {
          // Successfully scanned a bar code
          $("#scanTestResult").html("Gescand: " + result.text + " (" + result.format + ")");
        }
      }, function (error) {
        $("#scanTestResult").html("Scan mislukt: " + error);
      }
  );
}

function refreshBalance(companyname, cardnumber) {
  var mycards = JSON.parse(localStorage.getItem("mycards"));
  $.each(mycards, function (i, mycard) {
    if (mycard.cardnumber == cardnumber) {
      loadCardData(companyname, cardnumber, processCardResponse);
      return false; // breaks the loop
    }
  });
}

function removeCard(cardnumber) {
  if (confirm('Wil je deze kaart verwijderen?')) {
    var mycards = JSON.parse(localStorage.getItem("mycards"));
    $.each(mycards, function (i, mycard) {
      if (mycard.cardnumber == cardnumber) {
        mycards.splice(i, 1); // TODO this creates an empty entry
        localStorage.setItem("mycards", JSON.stringify(mycards));
        renderMycardsList(mycards);
        return false; // breaks the loop
      }
    });
  }
}

function renderMycardsList(mycards) {
  var htmlMyCards = '';
  if (mycards.length > 0) {
    htmlMyCards += '<li data-role="list-divider">Mijn kaarten</li>';
    $.each(mycards, function (i, mycard) {
      htmlMyCards += '' +
          '<li data-role="fieldcontain">' +
          '  <img src="img/card/' + mycard.cardcompany + '.png" />' +
          '  <div class="ui-grid-a">' +
          '    <div class="ui-block-a">' +
          '      <h3>' + formatAmount(mycard.saldo) + '</h3>' +
          '      <p>Saldo op ' + getDateString(mycard.checkdate) + '</p>' +
          '      <p class="cardnumber">' + mycard.cardnumber + '</p>' +
          '    </div>' +
          '    <div class="ui-block-b" style="text-align: right; margin-top: 8px">' +
          '      <a href="#" onclick="refreshBalance(\'' + mycard.cardcompany + '\', \'' + mycard.cardnumber + '\')"><img style="padding:6px; padding-top: 0" src="img/refresh.png" width="15px" height="16px" border="0"/></a>' +
          '      <br/>' +
          '      <a href="#" onclick="removeCard(\'' + mycard.cardnumber + '\')"><img style="padding:6px; padding-right: 8px" src="img/trash.png" width="16px" height="16px" border="0"/></a>' +
          '    </div>' +
          '  </div>' +
  //          '  </a>' +
          '</li>';
    });
  }
  $("#mycardsList").html(htmlMyCards);
  $("#mycardsList").listview("refresh");
}

// TODO from server?
// Note: keep them sorted!
var allcards = new Array(
    new Array("bartsmit", "Bart Smit", "3040012188580701179"),
    new Array("bijenkorf", "Bijenkorf", "901000007890000634092956"),
    new Array("bol", "Bol.com", ""),
    new Array("efteling", "Efteling", ""),
    new Array("fashioncheque", "Fashioncheque", "6046425110188147616"),
    new Array("fashioncheque", "Fashioncheque 2 (test)", "6046425115331753426"),
    new Array("hema", "HEMA", "300416828647599"),
    new Array("intratuin", "Intratuin", "6064362091069735993"),
    new Array("karwei", "Karwei", ""),
    new Array("missetam", "Miss Etam", ""),
    new Array("nationaleentertainmentcard", "Nationale Entertainment Card", ""),
    new Array("prenatal", "Prenatal", "3080017005005856058"),
    new Array("promiss", "Promiss", ""),
    new Array("vend", "V & D", ""),
    new Array("weekendjeweg", "Weekendjeweg.nl", "6064364100963753522"),
    new Array("wehkamp", "Wehkamp.nl", "")
);

function renderAllcardsList() {
  var htmlAllCards = '';
  $.each(allcards, function (i, card) {
    htmlAllCards += '' +
        '<div class="ui-block-' + (i % 2 == 0 ? 'a' : 'b') + '">' +
        '  <div class="cardcompany-name">' + card[1] + '</div>' +
        '  <div class="cardcompany-image"><img src="img/card/' + card[0] + '.png" class="scanButton" data-cardcompany="' + card[0] + '" alt="' + card[0] + '" data-testcard="' + card[2] + '"/></div>' +
        '</div>';
  });
  $("#allcardsList").html(htmlAllCards);
}

function processCardResponse(cardcompany, data) {
  $.mobile.loading('hide');
  if (data.success) {
    // add the cardcompany and store it
    data.cardcompany = cardcompany;
    var mycards = localStorage.getItem("mycards");
    var added = false;
    if (mycards == null) {
      mycards = new Array();
    } else {
      mycards = JSON.parse(mycards);
      // check if it existed... if so, remove it first
      $.each(mycards, function (i, mycard) {
        if (mycard.cardnumber == data.cardnumber) {
          added = true;
          mycards[i] = data;
          return false; // breaks the loop
        }
      });
    }

    if (!added) {
      mycards.push(data);
    }

    localStorage.setItem("mycards", JSON.stringify(mycards));
    // re-render the mycardslist
    renderMycardsList(mycards);
  } else {
    alert("Controleer uw invoer..");
  }
}
</script>

<!-- Page: Home page -->
<div id="homePage" data-role="page">
  <script language="JavaScript">
    $('#homePage').live('pagebeforeshow', function (e, data) {

      // render the list of scanned cards
      var mycards = localStorage.getItem("mycards");
      if (mycards != null) {
        renderMycardsList(JSON.parse(mycards));
      }

      renderAllcardsList();

      // bind behaviour to any buttons
      $('.scanButton').bind("click", function () {
        var cardcompany = $(this).attr("data-cardcompany");
        var testcardnr = $(this).attr("data-testcard");
        confirmInputtype(cardcompany, testcardnr);
      });
    });

  </script>
  <!--div data-role="header" data-tap-toggle="false">
    <h1>Kaartsaldo</h1>
    <a data-icon="info" data-iconpos="notext" href="#infoPopup" data-theme="b">info</a>
  </div-->
  <div>
    <ul id="mycardsList" data-role="listview" data-inset="false" data-divider-theme="a"></ul>
  </div>
  <div data-role="content">
    <ul data-role="listview" data-inset="false" data-divider-theme="d">
      <li data-role="list-divider">Voeg een kaart toe</li>
    </ul>
  </div>
  <div data-role="content" class="ui-grid-a" id="allcardsList"></div>
  <div data-role="content">
    <br/><br/><a href="" onclick="doTestScan()">scantest</a><br/>
    <div id="scanTestResult"></div><br/>
  </div>

</div>
<!-- End page: Home page -->


<!-- Page: Home page -->
<div id="unusedPage" data-role="page">
  <div data-role="header" data-theme="c" data-tap-toggle="false" data-position="fixed">
    <a id="backToLogin" data-icon="arrow-l" data-direction="reverse" href="#loginPage" class="button_back">log uit</a>

    <h1>Kaartsaldo</h1>
    <a data-icon="refresh" href="#"
       onclick="$.mobile.loading('show', {text:'Gegevens worden ververst..'}); setTimeout(function(){loadCardData(getLoginName(), getPassword(), function(data) {localStorage.setItem('CardResponse', JSON.stringify(data)); showCardData(); $.mobile.loading('hide');})},250)">vernieuw</a>
  </div>

  <div data-role="content">
  </div>
</div>
<!-- End page: Home page -->


</body>