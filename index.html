<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=0"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="format-detection" content="telephone=no">
  <title>Kaartsaldo app</title>
  <link rel="stylesheet" href="css/themes/default/jquery.mobile-1.2.0-alpha.1.min.css" type="text/css"/>
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Gudea:400,700,400italic" type="text/css"/>
  <link rel="stylesheet" href="css/kaartsaldo.css" type="text/css"/>
  <script src="js/lib/jquery.js"></script>
  <script src="js/kaartsaldo.custom.js"></script>
  <script src="js/jqm-init.js"></script>
  <script src="js/lib/jquery.mobile-1.2.0-alpha.1.min.js"></script>
  <script src="phonegap.js"></script>
  <script src="barcodescanner.js"></script>
</head>
<body>

<script type="text/javascript">
  function loadCardData(cardtype, cardnumber, successFunction) {
//    var url = "http://localhost:9004/cards";
    var url = "http://www.libwat.ch/cards";
    // for SSL, we can use this url, which is libwat.ch
//    var url = "https://morning-stone-3983.herokuapp.com/cards/bijenkorf";

    var data = {
      'cardtype': cardtype,
      'cardnumber': cardnumber
    };

    $.mobile.loading('show');

    setTimeout(function () {
      $.ajax({
        data: data,
        dataType:"json",
        async:false,
        type: 'POST',
        url:url,
        success:function(data){successFunction(cardtype, data)},
        error:function () {
          $.mobile.loading('hide');
          alert('Er is iets misgegaan. Probeer het nogmaals.');
        }
      });
    }, 250);
  }

  function scan(cardcompany, successFunction) {
    window.plugins.barcodeScanner.scan(function(result) {
      if (!result.cancelled) {
        // Successfully scanned a bar code
        loadCardData(cardcompany, result.text, successFunction);
      }

//       alert("We got a barcode\n" +
//          "Result: " + result.text + "\n" +
//          "Format: " + result.format + "\n" +
//          "Cancelled: " + result.cancelled);
        }, function(error) {
          alert("Scanning failed: " + error);
        }
    );
  }

  function renderMycardsList(mycards) {
    var htmlMyCards = '' +
        '<li data-role="list-divider" id="page_home_channellist_header">Mijn kaarten</li>';
    $.each(mycards, function (i, mycard) {

      htmlMyCards += '' +
          '<li data-role="fieldcontain">' +
          '  <img src="img/cardcompany/' + mycard.cardcompany + '.png" />' +
          '  <div class="ui-grid-a">' +
          '    <div class="ui-block-a">' +
          '      <h3>' + mycard.saldo +'</h3>' +
          '      <p>Laatste check: ' + mycard.checkdate + '</p>' +
          '      <p>' + mycard.cardnumber + '</p>' +
          '    </div>' +
          '    <div class="ui-block-b" style="text-align: right; margin-top: 8px">' +
          '      <a href="refresh">refresh</a>' +
          '      <br/>' +
          '      <br/>' +
          '      <a href="del">del</a>' +
          '    </div>' +
          '  </div>' +
//          '  </a>' +
          '</li>';
    });
    $("#mycardsList").html(htmlMyCards);
    $("#mycardsList").listview("refresh");
  }

  // TODO from server?
  // Note: keep them sorted!
  var allcards = new Array (
      new Array("bartsmit", "Bart Smit", "3040012188580701179"),
      new Array("fashioncheque", "Fashioncheque", "6046425110188147616"),
      new Array("hema", "HEMA", "300416828647599"),
      new Array("intratuin", "Intratuin", "6064362091069735993"),
      new Array("missetam", "Miss Etam", ""),
      new Array("prenatal", "Prenatal", "3080017005005856058"),
      new Array("promiss", "Promiss", "")
  );

  function renderAllcardsList() {
    var htmlAllCards = '' +
        '<li data-role="list-divider">Voeg een kaart toe!</li>';
    $.each(allcards, function (i, card) {
//      <li><img src="img/cardcompany/hema.png" class="scanButton" data-cardcompany="hema" alt="hema" data-testcard="300416828647599"/><h3>HEMA</h3></li>

      htmlAllCards += '' +
          '<li data-role="fieldcontain">' +
          '  <img src="img/cardcompany/' + card[0] + '.png" class="scanButton" data-cardcompany="'+card[0]+'" alt="['+card[0]+']" data-testcard="'+card[2]+'"/>' +
          '  <div class="ui-grid-a">' +
          '    <div class="ui-block-a">' +
          '      <h3>' + card[1] +'</h3>' +
//          '      <p>Laatste check: ' + card.checkdate + '</p>' +
//          '      <p>' + card.cardnumber + '</p>' +
          '    </div>' +
          '    <div class="ui-block-b" style="text-align: right; margin-top: 8px">' +
          '      <a href="refresh">refresh</a>' +
          '      <br/>' +
          '      <br/>' +
          '      <a href="del">del</a>' +
          '    </div>' +
          '  </div>' +
//          '  </a>' +
          '</li>';
    });
    $("#allcardsList").html(htmlAllCards);
    $("#allcardsList").listview("refresh");
  }

  function processCardResponse(cardcompany, data) {
    $.mobile.loading('hide');
    if (data.success) {
      // add the cardcompany and store it
      data.cardcompany = cardcompany;
      var mycards = localStorage.getItem("mycards");
      if (mycards == null) {
        mycards = new Array();
      } else {
        mycards = JSON.parse(mycards);
        // check if it existed... if so, remove it first
        $.each(mycards, function (i, mycard) {
          if (mycard.cardnumber == data.cardnumber) {
            mycards.splice(i, 1);
          }
        });
      }
      mycards.push(data);
      localStorage.setItem("mycards", JSON.stringify(mycards));
      // re-render the mycardslist
      renderMycardsList(mycards);
    } else {
      alert("Controleer uw invoer..");
    }
  }
</script>

<!-- Page: Home page -->
<div id="homePage" data-role="page">
  <script language="JavaScript">
    $('#homePage').live('pagebeforeshow', function (e, data) {

      // render the list of scanned cards
      var mycards = localStorage.getItem("mycards");
      if (mycards != null) {
        renderMycardsList(JSON.parse(mycards));
      }

      renderAllcardsList();

      // bind behaviour to any buttons
      $('.scanButton').bind("click", function () {
        var cardcompany = $(this).attr("data-cardcompany");
        if (isIOS() || isAndroid()) {
          scan(cardcompany, processCardResponse);
        } else {
          // debugging in browser
          var testcardnr = $(this).attr("data-testcard");
          loadCardData(cardcompany, testcardnr, processCardResponse);
        }
      });
    });

  </script>
  <div data-role="header" data-tap-toggle="false">
    <h1>Kaartsaldo</h1>
    <a data-icon="info" data-iconpos="notext" href="#infoPopup" data-theme="b">info</a>
  </div>
  <div data-role="content">
    <ul id="mycardsList" data-role="listview" data-inset="false" data-divider-theme="d"></ul>
    <ul id="allcardsList" data-role="listview" data-inset="false" data-divider-theme="d"></ul>
  </div>

</div>
<!-- End page: Home page -->


<!-- Page: Home page -->
<div id="unusedPage" data-role="page">
  <div data-role="header" data-theme="c" data-tap-toggle="false" data-position="fixed">
    <a id="backToLogin" data-icon="arrow-l" data-direction="reverse" href="#loginPage" class="button_back">log uit</a>
    <h1>Kaartsaldo</h1>
    <a data-icon="refresh" href="#" onclick="$.mobile.loading('show', {text:'Gegevens worden ververst..'}); setTimeout(function(){loadCardData(getLoginName(), getPassword(), function(data) {localStorage.setItem('CardResponse', JSON.stringify(data)); showCardData(); $.mobile.loading('hide');})},250)">vernieuw</a>
  </div>

  <div data-role="content">
  </div>
</div>
<!-- End page: Home page -->


</body>

nmjjgba